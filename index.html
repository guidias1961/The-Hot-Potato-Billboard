<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE PULSE BOARD // SYSTEM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --acid-green: #39FF14;
            --cyber-pink: #FF00FF;
            --void-black: #050505;
            --grid-color: #1a1a1a;
            --ui-border: 2px solid #333;
        }

        body {
            background-color: var(--void-black);
            color: #E0E0E0;
            font-family: 'Space Mono', monospace;
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow-x: hidden;
        }

        /* --- CRT SCANLINE EFFECT --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* --- TYPOGRAPHY & GLITCH --- */
        .font-header {
            font-family: 'Chakra Petch', sans-serif;
        }

        .glitch-text {
            position: relative;
        }
        .glitch-text::before, .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: var(--void-black);
        }
        .glitch-text::before {
            left: 2px;
            text-shadow: -1px 0 #ff00c1;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch-text::after {
            left: -2px;
            text-shadow: -1px 0 #00fff9;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% { clip: rect(38px, 9999px, 84px, 0); }
            20% { clip: rect(6px, 9999px, 86px, 0); }
            40% { clip: rect(22px, 9999px, 14px, 0); }
            60% { clip: rect(68px, 9999px, 5px, 0); }
            80% { clip: rect(57px, 9999px, 66px, 0); }
            100% { clip: rect(9px, 9999px, 49px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(18px, 9999px, 94px, 0); }
            20% { clip: rect(66px, 9999px, 2px, 0); }
            40% { clip: rect(2px, 9999px, 64px, 0); }
            60% { clip: rect(28px, 9999px, 15px, 0); }
            80% { clip: rect(97px, 9999px, 36px, 0); }
            100% { clip: rect(59px, 9999px, 29px, 0); }
        }

        /* --- UI ELEMENTS --- */
        .tactical-border {
            border: 1px solid var(--acid-green);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.1);
            position: relative;
        }
        
        /* Corner accents for tactical look */
        .tactical-border::after {
            content: '';
            position: absolute;
            bottom: -1px; right: -1px;
            width: 20px; height: 20px;
            border-bottom: 4px solid var(--acid-green);
            border-right: 4px solid var(--acid-green);
        }
        .tactical-border::before {
            content: '';
            position: absolute;
            top: -1px; left: -1px;
            width: 20px; height: 20px;
            border-top: 4px solid var(--acid-green);
            border-left: 4px solid var(--acid-green);
        }

        .neon-input {
            background: rgba(0,0,0,0.8);
            border: 1px solid #444;
            color: var(--acid-green);
            transition: all 0.3s ease;
        }
        .neon-input:focus {
            border-color: var(--acid-green);
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.2);
            outline: none;
        }

        .cyber-btn {
            background: var(--acid-green);
            color: black;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }
        .cyber-btn:hover:not(:disabled) {
            background: white;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        .cyber-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        /* Marquee */
        .marquee-strip {
            background: var(--acid-green);
            color: black;
            font-weight: bold;
            font-family: 'Chakra Petch';
            padding: 5px 0;
            border-bottom: 2px solid white;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div class="scanlines"></div>

    <div class="marquee-strip overflow-hidden whitespace-nowrap">
        <div class="inline-block animate-[scroll_20s_linear_infinite]">
            /// PULSECHAIN MAINNET /// THE BOARD IS LIVE /// EVERYTHING HAS A PRICE /// NO REFUNDS /// PROTECT YOUR BAGS /// OWN THE SPOT /// PULSECHAIN MAINNET /// 
        </div>
    </div>

    <header class="w-full max-w-7xl mx-auto p-4 md:p-6 flex justify-between items-center z-10">
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-[var(--acid-green)] animate-pulse"></div>
            <h1 class="text-3xl md:text-5xl font-header font-black tracking-tighter text-white glitch-text" data-text="THE_PULSE_BOARD">THE_PULSE_BOARD</h1>
        </div>
        
        <button id="connectBtn" class="cyber-btn px-6 py-2 text-sm md:text-lg clip-path-slant">
            [ CONNECT_WALLET ]
        </button>
    </header>

    <main class="flex-grow flex flex-col items-center w-full max-w-7xl mx-auto p-4 md:p-6 gap-6 z-10">

        <div class="w-full relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-gray-800 to-gray-900 blur opacity-75"></div>
            <div class="relative w-full aspect-video md:h-[60vh] bg-black tactical-border overflow-hidden">
                
                <div class="absolute top-4 left-4 z-20 flex flex-col gap-1">
                    <span class="bg-black text-[var(--acid-green)] px-2 py-1 text-xs border border-[var(--acid-green)]">LIVE FEED</span>
                    <span class="bg-black text-white px-2 py-1 text-xs border border-gray-600">ID: <span id="ownerDisplay">Loading...</span></span>
                </div>

                <div class="absolute top-4 right-4 z-20">
                    <div class="bg-[var(--cyber-pink)] text-white px-3 py-2 text-xl font-bold font-header border-2 border-white shadow-[4px_4px_0px_black]">
                        <span id="priceDisplay">0.0</span> PLS
                    </div>
                </div>

                <a id="targetLink" href="#" target="_blank" class="block w-full h-full cursor-pointer">
                    <img id="boardImage" src="https://placehold.co/1920x1080/050505/39FF14/png?text=INITIALIZING_SYSTEM..." alt="Board Content" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-all duration-300 grayscale-[20%] group-hover:grayscale-0">
                    
                    <div class="absolute inset-0 bg-[url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhYWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==')] opacity-20 pointer-events-none"></div>
                </a>
            </div>
        </div>

        <div class="w-full grid grid-cols-1 md:grid-cols-12 gap-6 mt-4">
            
            <div class="md:col-span-4 bg-black border border-gray-800 p-6 flex flex-col justify-between">
                <div>
                    <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-2">// SYSTEM_LOGS</h3>
                    <div class="font-mono text-sm space-y-2 text-[var(--acid-green)]">
                        <p>> Network: <span id="networkStatus" class="text-red-500">OFFLINE</span></p>
                        <p>> Contract: <span class="text-gray-400 text-xs">0x85CaCf...6007</span></p>
                        <p>> Uptime: 99.9%</p>
                    </div>
                </div>
                <div class="mt-8 pt-4 border-t border-gray-800 text-xs text-gray-400">
                    WARNING: This is a high-risk PvP environment. Purchasing the spot allows the next user to buy it from you at +20%. You profit 10%.
                </div>
            </div>

            <div class="md:col-span-8 bg-[#0a0a0a] border border-[#333] p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 font-black text-9xl select-none pointer-events-none">BUY</div>

                <div class="relative z-10 flex flex-col gap-4">
                    <h2 class="text-2xl font-header font-bold text-white mb-2">OVERWRITE_SEQUENCE</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1">
                            <label class="text-[var(--acid-green)] text-xs font-bold">>> IMG_SOURCE (URL)</label>
                            <input type="text" id="imgInput" class="neon-input p-3 w-full font-mono text-sm" placeholder="https://..." autocomplete="off">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[var(--acid-green)] text-xs font-bold">>> TARGET_LINK (URL)</label>
                            <input type="text" id="urlInput" class="neon-input p-3 w-full font-mono text-sm" placeholder="https://..." autocomplete="off">
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-center gap-4 mt-4">
                        <button id="buyBtn" class="w-full md:w-auto flex-grow cyber-btn py-4 text-xl tracking-widest bg-[var(--acid-green)] hover:bg-white transition-colors">
                            INITIATE TAKEOVER
                        </button>
                        <div id="txStatus" class="w-full md:w-auto text-center font-mono text-xs text-[var(--cyber-pink)] min-w-[200px]">
                            // WAITING FOR INPUT...
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        // ENDEREÇO CORRIGIDO DO CONTRATO
        const CONTRACT_ADDRESS = '0x85CaCf448c32279e101eA07A3C7Ae9659B796007'; 
        const CHAIN_ID_HEX = '0x171'; // 369 PulseChain
        const CHAIN_ID_DEC = 369;
        
        const ABI = [
            "function owner() view returns (address)",
            "function price() view returns (uint256)",
            "function imageURL() view returns (string)",
            "function targetURL() view returns (string)",
            "function purchaseSpot(string _img, string _url) payable",
            "event SpotPurchased(address indexed buyer, uint256 price)"
        ];

        // --- STATE & DOM ---
        let provider, signer, contract;
        let currentPrice = 0n;

        const connectBtn = document.getElementById('connectBtn');
        const networkStatus = document.getElementById('networkStatus');
        const boardImage = document.getElementById('boardImage');
        const targetLink = document.getElementById('targetLink');
        const ownerDisplay = document.getElementById('ownerDisplay');
        const priceDisplay = document.getElementById('priceDisplay');
        const buyBtn = document.getElementById('buyBtn');
        const imgInput = document.getElementById('imgInput');
        const urlInput = document.getElementById('urlInput');
        const txStatus = document.getElementById('txStatus');

        // --- INIT ---
        window.onload = () => {
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
                // Tenta conectar read-only de cara para popular o board
                initReadOnly();
            } else {
                connectBtn.innerText = "NO WALLET";
                connectBtn.disabled = true;
            }
        };

        async function initReadOnly() {
            try {
                // Read-only provider (se tiver RPC pública configurada no metamask, ou usa default)
                // Aqui usamos o window.ethereum mesmo sem permissão de conta para 'read' calls se a rede estiver certa
                const tempProvider = new ethers.BrowserProvider(window.ethereum);
                const network = await tempProvider.getNetwork();
                
                if (Number(network.chainId) === CHAIN_ID_DEC) {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, tempProvider);
                    fetchContractData();
                    networkStatus.innerText = "ONLINE (PULSE)";
                    networkStatus.className = "text-[var(--acid-green)]";
                }
            } catch (e) { console.log("Read-only init skipped"); }
        }

        // --- CONNECT ---
        connectBtn.addEventListener('click', async () => {
            if (!window.ethereum) return;
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleAccountsChanged(accounts);
            } catch (error) { console.error(error); }
        });

        async function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                connectBtn.innerText = "[ CONNECT_WALLET ]";
                networkStatus.innerText = "OFFLINE";
                networkStatus.className = "text-red-500";
            } else {
                const addr = accounts[0];
                connectBtn.innerText = `[ ${addr.substring(0,6)}...${addr.substring(38)} ]`;
                
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                await checkNetwork();
            }
        }

        async function checkNetwork() {
            const network = await provider.getNetwork();
            if (Number(network.chainId) !== CHAIN_ID_DEC) {
                networkStatus.innerText = "WRONG NETWORK";
                networkStatus.className = "text-red-500 blink";
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CHAIN_ID_HEX }],
                    });
                } catch (err) {
                    if (err.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CHAIN_ID_HEX,
                                chainName: 'PulseChain',
                                nativeCurrency: { name: 'Pulse', symbol: 'PLS', decimals: 18 },
                                rpcUrls: ['https://rpc.pulsechain.com'],
                                blockExplorerUrls: ['https://scan.pulsechain.com'],
                            }],
                        });
                    }
                }
            } else {
                networkStatus.innerText = "ONLINE (PULSE)";
                networkStatus.className = "text-[var(--acid-green)]";
                fetchContractData();
            }
        }

        // --- CORE LOGIC ---
        async function fetchContractData() {
            if (!contract) return;
            txStatus.innerHTML = "// SYNCING DATA...";
            
            try {
                const [owner, price, img, url] = await Promise.all([
                    contract.owner(),
                    contract.price(),
                    contract.imageURL(),
                    contract.targetURL()
                ]);

                currentPrice = price;
                ownerDisplay.innerText = owner.substring(0, 6) + "..." + owner.substring(38);
                
                // Formatação bonita
                const formattedPrice = parseFloat(ethers.formatEther(price)).toFixed(2);
                priceDisplay.innerText = formattedPrice;
                buyBtn.innerText = `STEAL SPOT (${formattedPrice} PLS)`;
                
                if (img && img.length > 0) boardImage.src = img;
                if (url && url.length > 0) targetLink.href = url;

                txStatus.innerText = "// SYSTEM READY";
            } catch (err) {
                console.error(err);
                txStatus.innerText = "ERR: SYNC FAILED";
            }
        }

        buyBtn.addEventListener('click', async () => {
            if (!contract) return alert("CONNECT WALLET FIRST");
            
            const imgVal = imgInput.value.trim();
            const urlVal = urlInput.value.trim();

            if (!imgVal) return alert("IMAGE URL REQUIRED");

            try {
                txStatus.innerText = ">> CONFIRM TRANSACTION...";
                const tx = await contract.purchaseSpot(imgVal, urlVal, { value: currentPrice });
                
                txStatus.innerHTML = `<span class="animate-pulse">>> MINING TX...</span>`;
                buyBtn.disabled = true;
                
                await tx.wait();
                
                txStatus.innerText = ">> SUCCESS. OWNERSHIP TRANSFERRED.";
                buyBtn.disabled = false;
                
                // Limpa campos e atualiza na hora
                imgInput.value = "";
                urlInput.value = "";
                fetchContractData();

            } catch (err) {
                console.error(err);
                buyBtn.disabled = false;
                txStatus.innerText = ">> TX FAILED / REJECTED";
            }
        });
    </script>
</body>
</html>
