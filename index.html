<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE PULSE GRID // SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --acid-green: #39FF14;
            --cyber-pink: #FF00FF;
            --void-black: #050505;
            --grid-color: #1a1a1a;
        }
        body {
            background-color: var(--void-black);
            color: #E0E0E0;
            font-family: 'Space Mono', monospace;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 9999;
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 2px, 3px 100%;
        }
        .font-header { font-family: 'Chakra Petch', sans-serif; }
        .tactical-border {
            border: 1px solid var(--acid-green);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.1);
            position: relative; transition: all 0.3s;
        }
        /* Selected State */
        .tactical-border.selected {
            border-color: var(--cyber-pink);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.4);
            transform: scale(1.01); z-index: 50;
        }
        .cyber-btn {
            background: var(--acid-green); color: black; font-family: 'Chakra Petch', sans-serif; font-weight: 700; text-transform: uppercase;
            transition: all 0.2s; cursor: pointer;
        }
        .cyber-btn:hover:not(:disabled) { background: white; transform: translateY(-2px); }
        .cyber-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        .neon-input { background: rgba(0,0,0,0.8); border: 1px solid #444; color: var(--acid-green); }
        .neon-input:focus { border-color: var(--acid-green); outline: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div class="scanlines"></div>

    <div class="overflow-hidden whitespace-nowrap bg-[var(--acid-green)] text-black font-bold font-header py-1 border-b-2 border-white">
        <div class="inline-block animate-[scroll_20s_linear_infinite]">
            /// PULSE GRID LIVE /// 5 SPOTS AVAILABLE /// CLAIM YOUR TERRITORY /// PVP MARKETPLACE ///
        </div>
    </div>

    <header class="w-full max-w-7xl mx-auto p-4 flex justify-between items-center z-10">
        <h1 class="text-3xl md:text-5xl font-header font-black text-white">THE_PULSE_GRID</h1>
        <button id="connectBtn" class="cyber-btn px-6 py-2 text-sm md:text-lg">[ CONNECT ]</button>
    </header>

    <main class="flex-grow flex flex-col items-center w-full max-w-7xl mx-auto p-4 gap-6 z-10">

        <div class="w-full flex flex-col gap-4">
            
            <div class="w-full">
                <div class="text-xs text-gray-500 mb-1 font-bold">>> MAIN_BANNER (ID: 0)</div>
                <div id="spot-0" onclick="selectSpot(0)" class="tactical-border w-full aspect-[3/1] bg-black relative cursor-pointer group">
                    <div class="absolute top-2 left-2 z-20 bg-black text-[var(--acid-green)] px-2 text-xs border border-[var(--acid-green)]">BANNER</div>
                    <div class="absolute bottom-2 right-2 z-20 bg-[var(--cyber-pink)] text-white px-2 font-bold text-lg price-tag">Loading...</div>
                    <img src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity spot-img">
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div id="spot-1" onclick="selectSpot(1)" class="tactical-border w-full aspect-square bg-black relative cursor-pointer group">
                    <div class="absolute top-2 left-2 z-20 bg-black text-white px-1 text-[10px] border border-gray-600">ID: 1</div>
                    <div class="absolute bottom-2 right-2 z-20 bg-gray-800 text-white px-1 text-sm font-bold price-tag">...</div>
                    <img src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity spot-img">
                </div>
                <div id="spot-2" onclick="selectSpot(2)" class="tactical-border w-full aspect-square bg-black relative cursor-pointer group">
                    <div class="absolute top-2 left-2 z-20 bg-black text-white px-1 text-[10px] border border-gray-600">ID: 2</div>
                    <div class="absolute bottom-2 right-2 z-20 bg-gray-800 text-white px-1 text-sm font-bold price-tag">...</div>
                    <img src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity spot-img">
                </div>
                <div id="spot-3" onclick="selectSpot(3)" class="tactical-border w-full aspect-square bg-black relative cursor-pointer group">
                    <div class="absolute top-2 left-2 z-20 bg-black text-white px-1 text-[10px] border border-gray-600">ID: 3</div>
                    <div class="absolute bottom-2 right-2 z-20 bg-gray-800 text-white px-1 text-sm font-bold price-tag">...</div>
                    <img src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity spot-img">
                </div>
                <div id="spot-4" onclick="selectSpot(4)" class="tactical-border w-full aspect-square bg-black relative cursor-pointer group">
                    <div class="absolute top-2 left-2 z-20 bg-black text-white px-1 text-[10px] border border-gray-600">ID: 4</div>
                    <div class="absolute bottom-2 right-2 z-20 bg-gray-800 text-white px-1 text-sm font-bold price-tag">...</div>
                    <img src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity spot-img">
                </div>
            </div>
        </div>

        <div class="w-full bg-[#0a0a0a] border border-[#333] p-6 mt-4 relative overflow-hidden">
            <div class="relative z-10 flex flex-col gap-4">
                <div class="flex justify-between items-end">
                    <h2 class="text-2xl font-header font-bold text-white">OVERWRITE_SPOT: <span id="selectedIDDisplay" class="text-[var(--cyber-pink)]">NONE</span></h2>
                    <div id="sizeRequirement" class="text-xs font-mono text-gray-400 border border-gray-600 px-2 py-1">SELECT A SPOT</div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[var(--acid-green)] text-xs font-bold">>> UPLOAD_IMG</label>
                        <label for="fileInput" id="fileLabel" class="border-2 dashed border-[#444] bg-black/50 text-gray-500 cursor-pointer p-3 text-center text-xs hover:border-[var(--acid-green)] transition">
                            CLICK TO UPLOAD
                        </label>
                        <input type="file" id="fileInput" class="hidden" accept="image/*">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[var(--acid-green)] text-xs font-bold">>> TARGET_URL</label>
                        <input type="text" id="urlInput" class="neon-input p-3 w-full font-mono text-sm" placeholder="https://..." autocomplete="off">
                    </div>
                </div>

                <div class="flex items-center gap-4 mt-2">
                    <button id="buyBtn" disabled class="flex-grow cyber-btn py-4 text-xl tracking-widest">SELECT A SPOT</button>
                </div>
                <div id="txStatus" class="text-center font-mono text-xs text-[var(--cyber-pink)]">// WAITING FOR SELECTION...</div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // MANTENHA SUAS CHAVES AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyBty17Qc_miNbnFYJrP6f_uPUh6YisLUZI",
            authDomain: "pulseboard-7a0ff.firebaseapp.com",
            projectId: "pulseboard-7a0ff",
            storageBucket: "pulseboard-7a0ff.firebasestorage.app",
            messagingSenderId: "231905038718",
            appId: "1:231905038718:web:0d65a3d07c54b60f80632f",
            measurementId: "G-PB9TJBE7X4"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        window.uploadImageToFirebase = async (file) => {
            const fileName = `grid/${Date.now()}-${file.name}`;
            const storageRef = ref(storage, fileName);
            const snapshot = await uploadBytes(storageRef, file);
            return await getDownloadURL(snapshot.ref);
        };
    </script>

    <script>
        // --- ATUALIZE COM O NOVO ENDEREÇO DO CONTRATO DEPOIS DO DEPLOY ---
        const CONTRACT_ADDRESS = 0xc42fe186B8e5011a8D90bc8E154433E849D300Ac; 
        // -----------------------------------------------------------------
        
        const CHAIN_ID_DEC = 369;
        const CHAIN_ID_HEX = '0x171';
        
        // ABI ATUALIZADA PARA O NOVO CONTRATO (getSpot)
        const ABI = [
            "function getSpot(uint256 _id) view returns (tuple(address owner, uint256 price, string imageURL, string targetURL))",
            "function purchaseSpot(uint256 _spotId, string _img, string _url) payable"
        ];

        let provider, signer, contract;
        let selectedSpotId = null;
        let spotPrices = {}; // Cache prices

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const sizeReq = document.getElementById('sizeRequirement');
        const buyBtn = document.getElementById('buyBtn');
        const txStatus = document.getElementById('txStatus');
        const selectedIDDisplay = document.getElementById('selectedIDDisplay');

        // File UI Logic
        fileInput.addEventListener('change', () => {
            if(fileInput.files.length > 0) {
                fileLabel.innerText = ">> " + fileInput.files[0].name;
                fileLabel.style.borderColor = "var(--cyber-pink)";
                fileLabel.style.color = "var(--cyber-pink)";
            }
        });

        // --- SELECTION LOGIC ---
        window.selectSpot = (id) => {
            selectedSpotId = id;
            
            // Visual Update
            document.querySelectorAll('.tactical-border').forEach(el => el.classList.remove('selected'));
            document.getElementById(`spot-${id}`).classList.add('selected');
            
            // Info Update
            selectedIDDisplay.innerText = `ID #${id}`;
            
            if(id === 0) {
                sizeReq.innerText = "RECOMMENDED SIZE: 1500x500px (3:1)";
                sizeReq.style.color = "var(--acid-green)";
            } else {
                sizeReq.innerText = "RECOMMENDED SIZE: 500x500px (1:1)";
                sizeReq.style.color = "var(--acid-green)";
            }

            // Update Button
            const price = spotPrices[id] || "0";
            buyBtn.innerText = `BUY SPOT #${id} (${price} PLS)`;
            buyBtn.disabled = false;
        };

        // --- BLOCKCHAIN LOGIC ---
        window.onload = () => {
            if (window.ethereum) {
                initReadOnly();
            }
        };

        async function initReadOnly() {
            try {
                const tempProvider = new ethers.BrowserProvider(window.ethereum);
                const network = await tempProvider.getNetwork();
                if (Number(network.chainId) === CHAIN_ID_DEC) {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, tempProvider);
                    fetchAllSpots();
                }
            } catch(e) { console.log(e); }
        }

        async function fetchAllSpots() {
            txStatus.innerText = "// SYNCING GRID...";
            try {
                // Loop ID 0 to 4
                for(let i=0; i<=4; i++) {
                    const data = await contract.getSpot(i);
                    updateSpotUI(i, data);
                }
                txStatus.innerText = "// SYSTEM READY";
            } catch(e) {
                console.error(e);
                txStatus.innerText = "ERR: SYNC FAILED";
            }
        }

        function updateSpotUI(id, data) {
            const el = document.getElementById(`spot-${id}`);
            const imgEl = el.querySelector('.spot-img');
            const priceEl = el.querySelector('.price-tag');
            
            // Update Image
            if(data.imageURL.length > 5) imgEl.src = data.imageURL;
            
            // Update Price Cache & UI
            const formattedPrice = parseFloat(ethers.formatEther(data.price)).toFixed(0);
            spotPrices[id] = formattedPrice;
            priceEl.innerText = `${formattedPrice} PLS`;

            // Make clickable link wrapper (optional behavior)
            // Note: In edit mode we want to click to select, so we don't wrap in <a> tag here.
            // But we could add an "External Link" icon if we wanted.
        }

        document.getElementById('connectBtn').addEventListener('click', async () => {
            if (!window.ethereum) return;
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            document.getElementById('connectBtn').innerText = "[ CONNECTED ]";
            fetchAllSpots();
        });

        buyBtn.addEventListener('click', async () => {
            if(selectedSpotId === null) return alert("SELECT A SPOT FIRST");
            if(!contract) return alert("CONNECT WALLET");
            
            const file = fileInput.files[0];
            const url = document.getElementById('urlInput').value;
            
            if(!file) return alert("UPLOAD IMAGE REQ");
            if(!url) return alert("URL REQ");

            try {
                buyBtn.disabled = true;
                txStatus.innerText = ">> UPLOADING TO FIREBASE...";
                
                const imgUrl = await window.uploadImageToFirebase(file);
                
                txStatus.innerText = ">> CONFIRM ON WALLET...";
                // Pega preço atual do contrato (segurança)
                const spotData = await contract.getSpot(selectedSpotId);
                const price = spotData.price;

                const tx = await contract.purchaseSpot(selectedSpotId, imgUrl, url, { value: price });
                
                txStatus.innerText = ">> MINING...";
                await tx.wait();
                
                txStatus.innerText = ">> SUCCESS!";
                fetchAllSpots();
                buyBtn.disabled = false;
                
            } catch(e) {
                console.error(e);
                txStatus.innerText = ">> ERROR: " + (e.reason || "FAILED");
                buyBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
